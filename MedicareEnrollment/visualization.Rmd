---
title: "Medicare enrollment"
author: 'Yan He'
date: '05/14/2021'
output:
  # pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
library(tidyverse) 
library(ggplot2)
library(maps) 
library(mapdata)
library(gridExtra) # used for combining plots
```

## Start the visualization of the Medicare enrollment
```{r}
setwd("E:/Repositories/HealthcareSpending/MedicareEnrollment")
load("by_time.rda")
load("by_demo.rda")
load("by_state.rda")
load("pop.rda")
```

```{r}
# Medicare enrollment by Medicare type
# df <- by.time[,c('year', 'org.enroll', 'ma.enroll')] %>%
#   pivot_longer(cols=c('org.enroll', 'ma.enroll'), 
#                names_to = 'var',
#                values_to = 'value') %>%
#   group_by(year) %>% 
#   mutate(total.enroll=round(sum(value)/1000000,1)) %>%
#   mutate(value = round(value/1000000,1)) %>%
#   mutate(pct = round(value/total.enroll*100,1),
#          pctlab = paste0(pct,'%'))

# df %>% 
#   ggplot(aes(x = year, y = value, fill = var)) +
#   geom_bar(stat = "identity") +
#   scale_x_continuous(breaks=seq(2008,2019,1)) +
#   geom_text(aes(label = value), size = 3, position = position_stack(vjust = 0.9)) + 
#   geom_text(aes(label = pctlab), size = 3, position = position_stack(vjust = 0.5)) +
#   theme_bw()+
#   labs(title= "Medicare Enrollment over time",
#        y="Beneficiaries (million)", x = "Year") +
#   scale_fill_manual(name = "Medicare Type", 
#                     values=c("grey","tan"),labels = c("MA/Part C", "Original"))

data_plot <- function(by.time, varlist) {
  df <- by.time[,c('year', varlist)] %>%
  pivot_longer(cols=varlist, 
               names_to = 'var',
               values_to = 'value') %>%
  group_by(year) %>% 
  mutate(total=round(sum(value)/1000000,1)) %>%
  mutate(value = round(value/1000000,1)) %>%
  mutate(pct = round(value/total*100,1),
         pctlab = paste0(pct,'%'))
  return(df)
}

bar_plot <- function(df ,title, ylabel, legend_name, lengend_color, legend_label) {
 df %>% 
  ggplot(aes(x = year, y = value, fill = var)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks=seq(2008,2019,1)) +
  geom_text(aes(label = value), size = 3, position = position_stack(vjust = 0.9)) + 
  geom_text(aes(label = pctlab), size = 3, position = position_stack(vjust = 0.5)) +
  theme_bw()+
  labs(title= title, y=ylabel, x = "Year") +
  scale_fill_manual(name = legend_name, 
                    values=lengend_color,labels = legend_label) 
}

# by MA/original
df <- data_plot(by.time, varlist=c('org.enroll', 'ma.enroll'))
bar_plot(df,title="Medicare Enrollment over time", 
          ylabel="Beneficiaries (million)", 
          legend_name="Medicare Type", lengend_color=c("grey","tan"),
          legend_label=c("MA/Part C", "Original"))

# by Aged/Disabled
df <- data_plot(by.time, varlist=c("AorB.aged","AorB.disabled"))
bar_plot(df,title="Medicare Enrollment over time", 
          ylabel="Beneficiaries (million)", 
          legend_name="Cohort", lengend_color=c("grey","tan"),
          legend_label=c("Aged", "Disabled"))

# by more detailed age group
agegrp.all <- c('count.under25','count.25to34', 'count.35to44','count.45to54',
            'count.55to64', 'count.65to74', 'count.75to84', 'count.over85')
varlist <- gsub("count.","",agegrp.all)
df <- data_plot(by.time, varlist=agegrp.all)
df$var <- gsub("count.","",df$var)
df$var <- factor(df$var, levels = rev(varlist))

custom.col <- c("#FFDB6D", "#C4961A", "#CC79A7","#D16103", 
                "#C3D7A4", "#52854C", "#4E84C4", "#293352")
df %>%
  ggplot(aes(x = year, y = value, fill = var)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks=seq(2008,2019,1)) +
  theme_bw()+
  labs(title= 'Medicare enrollment age distribution', y='Beneficiaries (million)', x = "Year") +
  scale_fill_manual(name = 'Age group', 
                    values=custom.col,labels = rev(varlist)) 
  

# by Part D
df <- data_plot(by.time, varlist=c("partD.enroll", "retiree.rx.subsidy", "no.pd.rx.retiree.subsidy"))
df[df$var=='retiree.rx.subsidy', 'pctlab'] = ''
bar_plot(df,title="Prescription drug coverage", 
          ylabel="Beneficiaries (million)", 
          legend_name="Cohort", lengend_color=c("grey","tan", "cadetblue"),
          legend_label=c("No PartD or \nRetiree subsidy", "Part D", 
                         "Retiree Rx subsidy"))

# by gender
df <- by.demo %>%
  filter(group %in% c('male', 'female')) %>%
  select(c(year, group, AorB.total))
colnames(df) <- c('year', "var", "value")
df <- df %>% 
  group_by(year) %>%
  mutate(total=round(sum(value)/1000000,1)) %>%
  mutate(value = round(value/1000000,1)) %>%
  mutate(pct = round(value/total*100,1),
         pctlab = paste0(pct,'%'))
bar_plot(df,title="Medicare enrollment By gender", 
          ylabel="Beneficiaries (million)", 
          legend_name="Cohort", lengend_color=c("grey","tan"),
          legend_label=c("Female", "Male"))
```
## Medicare part D composition
```{r}
df <- data_plot(by.time, varlist=c("stand.alone", "ma.rx"))
bar_plot(df,title="Part D Enrollment over time", 
          ylabel="Beneficiaries (million)", 
          legend_name="Part D Type", lengend_color=c("grey","tan", "cadetblue"),
          legend_label=c("Stand-alone", "From MA"))
```
## Among all population, the enrollment rate
```{r}
pop['sex'] <- 'male'
pop[pop$Gender==1, 'sex'] <- 'female'
bygender <- pop %>%
  group_by(Year, sex) %>%
  summarise(pop = sum(Population))
colname <- c('year', 'group', 'pop')
colnames(bygender) <- colname

byage <- pop %>%
  group_by(Year, age.group) %>%
  summarise(pop = sum(Population))
colnames(byage) <- colname

totpop <- pop %>%
  group_by(Year) %>%
  summarise(pop = sum(Population))
totpop['group'] <- 'total'
colnames(totpop) <- c('year', 'pop', 'group')

pop.demo <- bygender %>%
  bind_rows(byage) %>%
  bind_rows(totpop)
```

## Among Medicare beneficiaries, the percentage enrolled in MA, part D by demo
```{r}
agegrp.all <- c('count.under25','count.25to34', 'count.35to44','count.45to54', 
            'count.55to64', 'count.65to74', 'count.75to84', 'count.over85')
# # make a plot of the Medicare share of each age
# agegrp.share <- gsub("count.","share.",agegrp.all)
# df <- by.time[,c('year', agegrp.share)] %>%
#   pivot_longer(cols=agegrp.share,
#                names_to = 'var',
#                values_to = 'value')
# df %>%
#   ggplot(aes(x = year, y = value, group=var, color = var)) +
#   geom_line()+
#   scale_x_continuous(breaks=seq(2008,2019,1)) +
#   theme_bw()+
#   labs(title= "Age group distribution among Medicare beneficiaries",
#        y="Percentage", x = "Year", colour = 'Age group') 

# # Medicare enrollment by Medicare type
agegrp.ma <- paste0(agegrp.all, '.MA')

df1 <- by.time[,c('year', agegrp.all)] %>%
  pivot_longer(cols=agegrp.all,
               names_to = 'var',
               values_to = 'value.total')
df2 <- by.time[,c('year', agegrp.ma)] %>%
  pivot_longer(cols=agegrp.ma,
               names_to = 'var',
               values_to = 'value.MA')

df2$var <- gsub(".MA","",df2$var)
df <- df1 %>% full_join(df2, by = c("year", "var"))
df['value'] <- round(df$value.MA/df$value.total*100,2)
df$var <- gsub("count.","",df2$var)

var_order <- gsub("count.","",agegrp.all)
df$var <- factor(df$var, levels = rev(var_order))

df %>%
  ggplot(aes(x = year, y = value, group=var, color = var)) +
  geom_line()+
  scale_x_continuous(breaks=seq(2008,2019,1)) +
  theme_bw()+
  labs(title= "Medicare Advantage share among all Medicare",
       y="Percentage", x = "Year", colour = 'Age group') 
```

```{r}
df <- by.demo %>% 
  select(c(year,group,AorB.total,AorB.total.MA, partD.enroll,total.enroll)) %>%
  left_join(pop.demo,by=c('year', 'group')) %>%
  mutate(enrollrate.ma=AorB.total.MA/total.enroll*100,
         enrollrate.pd=partD.enroll/total.enroll*100,
         enrollrate.mcr = total.enroll/pop*100)
df[!is.na(df$enrollrate.mcr) & df$enrollrate.mcr>100, 'enrollrate.mcr'] <- 100
# interestingly, the enrollment number is greater than the population

line_plot <- function(df, var, keep_group, title, ylabel,legend_name) {
  
  df.plot <- df[,c('year', 'group', var)] %>%
    filter(group %in% keep_group)
  colnames(df.plot) <- c('year', 'var', 'value')
  if ('under25' %in% keep_group) {
    df.plot$var <- factor(df.plot$var, levels = rev(var_order))
  }

  df.plot %>%
    ggplot(aes(x = year, y = value, group=var, color = var)) +
    geom_line()+
    scale_x_continuous(breaks=seq(2008,2019,1)) +
    theme_bw()+
    labs(title= title,y=ylabel, x = "Year", colour = legend_name) 
}

line_plot(df, var="enrollrate.ma", 
      keep_group=c('male', 'female', 'total'), 
      title='Medicare Advantage share among all Medicare', 
      ylabel='Percentage',legend_name='Gender')

line_plot(df, var="enrollrate.pd", 
      keep_group=c('male', 'female','total'), 
      title='Medicare Part D enrollment rate among Medicare beneficiaries', 
      ylabel='Percentage', legend_name='Gender')
line_plot(df, var="enrollrate.pd", 
      keep_group=var_order, 
      title='Medicare Part D enrollment rate among Medicare beneficiaries', 
      ylabel='Percentage', legend_name='Age group')

# enrollment rate by demo
line_plot(df, var="enrollrate.mcr", 
      keep_group=c('male', 'female', 'total'), 
      title='Medicare enrollment rate', 
      ylabel='Percentage',legend_name='Gender')

line_plot(df, var="enrollrate.mcr", 
      keep_group=c('under25','25to34', '35to44','45to54','55to64'), 
      title='Medicare enrollment rate among disabled', 
      ylabel='Percentage', legend_name='Age group')
line_plot(df, var="enrollrate.mcr", 
      keep_group=c('65to74', '75to84', 'over85'),
      title='Medicare enrollment rate among elderly', 
      ylabel='Percentage', legend_name='Age group')

```


